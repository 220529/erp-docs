# 数据库设计

## ER 图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心业务实体                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐         ┌──────────────┐         ┌──────────────┐        │
│  │   Customer   │ 1    n  │    Order     │ 1    n  │   Payment    │        │
│  │    客户      │────────▶│    订单      │────────▶│    收款      │        │
│  └──────────────┘         └──────┬───────┘         └──────────────┘        │
│         │                        │                                          │
│         │ 1                      │ 1                                        │
│         │ n                      │ n                                        │
│         ▼                        ▼                                          │
│  ┌──────────────┐         ┌──────────────┐                                 │
│  │CustomerFollow│         │OrderMaterial │                                 │
│  │  客户跟进    │         │  订单材料    │                                 │
│  └──────────────┘         └──────────────┘                                 │
│                                  │                                          │
│                                  │ n                                        │
│                                  │ 1                                        │
│                                  ▼                                          │
│  ┌──────────────┐         ┌──────────────┐         ┌──────────────┐        │
│  │   Product    │ n    n  │ProductMaterial│ n    1 │   Material   │        │
│  │    产品      │────────▶│  产品材料    │◀────────│    材料      │        │
│  └──────────────┘         └──────────────┘         └──────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              系统管理实体                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐         ┌──────────────┐         ┌──────────────┐        │
│  │   Company    │ 1    n  │  Department  │ n    1  │     User     │        │
│  │    公司      │────────▶│    部门      │◀────────│    用户      │        │
│  └──────────────┘         └──────────────┘         └──────────────┘        │
│                                  │                        │                 │
│                                  │ 自关联(树形)            │                 │
│                                  ▼                        ▼                 │
│                                                    ┌──────────────┐        │
│  ┌──────────────┐         ┌──────────────┐        │     Role     │        │
│  │     Menu     │ n    n  │   RoleMenu   │ n    1 │    角色      │        │
│  │    菜单      │────────▶│  角色菜单    │◀────────└──────────────┘        │
│  └──────────────┘         └──────────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心表结构

### 客户表 (customers)
| 字段 | 类型 | 说明 |
|-----|------|-----|
| id | int | 主键 |
| name | varchar(50) | 客户姓名 |
| mobile | varchar(20) | 手机号 |
| address | text | 地址 |
| status | enum | new/measured/quoted/signed/completed |
| designer_id | int | 设计师ID |

### 订单表 (orders)
| 字段 | 类型 | 说明 |
|-----|------|-----|
| id | int | 主键 |
| order_no | varchar(50) | 订单号(唯一) |
| customer_id | int | 客户ID |
| status | enum | pending/signed/in_progress/completed/voided |
| total_amount | decimal(10,2) | 订单总金额 |
| paid_amount | decimal(10,2) | 已收金额 |
| cost_amount | decimal(10,2) | 成本金额 |

### 收款表 (payments)
| 字段 | 类型 | 说明 |
|-----|------|-----|
| id | int | 主键 |
| payment_no | varchar(50) | 收款单号 |
| order_id | int | 订单ID |
| amount | decimal(10,2) | 收款金额 |
| method | enum | cash/wechat/alipay/bank |
| status | enum | pending/confirmed/cancelled |

### 用户表 (users)
| 字段 | 类型 | 说明 |
|-----|------|-----|
| id | int | 主键 |
| username | varchar(50) | 用户名(唯一) |
| password | varchar(255) | 密码(加密) |
| name | varchar(50) | 姓名 |
| role | varchar(50) | 角色标识 |
| company_id | int | 公司ID |
| department_id | int | 部门ID |

## 状态枚举

```typescript
// 客户状态
enum CustomerStatus {
  NEW = 'new',           // 新客户
  MEASURED = 'measured', // 已量房
  QUOTED = 'quoted',     // 已报价
  SIGNED = 'signed',     // 已签约
  COMPLETED = 'completed' // 已完工
}

// 订单状态
enum OrderStatus {
  PENDING = 'pending',       // 待签约
  SIGNED = 'signed',         // 已签约
  IN_PROGRESS = 'in_progress', // 施工中
  COMPLETED = 'completed',   // 已完工
  VOIDED = 'voided'          // 已作废
}

// 收款状态
enum PaymentStatus {
  PENDING = 'pending',     // 待确认
  CONFIRMED = 'confirmed', // 已确认
  CANCELLED = 'cancelled'  // 已取消
}
```

## 索引设计

```sql
-- 客户表索引
CREATE INDEX idx_customers_mobile ON customers(mobile);
CREATE INDEX idx_customers_status ON customers(status);

-- 订单表索引
CREATE UNIQUE INDEX idx_orders_no ON orders(order_no);
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_status ON orders(status);

-- 收款表索引
CREATE UNIQUE INDEX idx_payments_no ON payments(payment_no);
CREATE INDEX idx_payments_order ON payments(order_id);
```
