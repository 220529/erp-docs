# 订单管理

## 订单状态流转

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           订单状态流转图                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────────┐                                │
│                              │   创建订单   │                                │
│                              └──────┬──────┘                                │
│                                     │                                       │
│                                     ▼                                       │
│                              ┌─────────────┐                                │
│                              │   待签约    │                                │
│                              │   PENDING   │                                │
│                              └──────┬──────┘                                │
│                                     │                                       │
│                    ┌────────────────┼────────────────┐                      │
│                    │                │                │                      │
│                    ▼                ▼                                       │
│             ┌─────────────┐  ┌─────────────┐                               │
│             │   已签约    │  │   已作废    │                               │
│             │   SIGNED    │  │   VOIDED    │                               │
│             └──────┬──────┘  └─────────────┘                               │
│                    │                                                        │
│                    ▼                                                        │
│             ┌─────────────┐                                                │
│             │   施工中    │                                                │
│             │ IN_PROGRESS │                                                │
│             └──────┬──────┘                                                │
│                    │                                                        │
│                    ▼                                                        │
│             ┌─────────────┐                                                │
│             │   已完工    │                                                │
│             │  COMPLETED  │                                                │
│             └─────────────┘                                                │
│                                                                             │
│  状态说明：                                                                  │
│  • PENDING: 订单已创建，等待客户签约                                         │
│  • SIGNED: 客户已签约，可以开始施工                                          │
│  • IN_PROGRESS: 正在施工中                                                  │
│  • COMPLETED: 施工完成，订单结束                                             │
│  • VOIDED: 订单作废，不再有效                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 订单字段

| 字段 | 说明 | 必填 |
|-----|------|-----|
| orderNo | 订单号（自动生成） | 是 |
| customerId | 关联客户 | 是 |
| status | 订单状态 | 是 |
| totalAmount | 订单总金额 | 是 |
| paidAmount | 已收金额（自动计算） | - |
| costAmount | 成本金额（自动计算） | - |
| designerId | 设计师 | 否 |
| foremanId | 工长 | 否 |
| signedAt | 签约时间 | 否 |
| startedAt | 开工时间 | 否 |
| completedAt | 完工时间 | 否 |

## API 接口

| 接口 | 方法 | 说明 |
|-----|------|-----|
| /api/orders | GET | 订单列表 |
| /api/orders/:id | GET | 订单详情 |
| /api/orders | POST | 创建订单 |
| /api/orders/:id | PUT | 更新订单 |
| /api/orders/:id/status | PUT | 更新状态 |
| /api/orders/:id | DELETE | 删除订单 |
| /api/orders/:id/materials | GET | 订单材料列表 |
| /api/orders/:id/materials | POST | 添加材料 |

## 业务规则

### 创建订单
1. 必须关联已存在的客户
2. 订单号自动生成：`ORD + 年月日 + 4位序号`
3. 初始状态为 `pending`（待签约）
4. 客户状态自动更新为 `signed`（已签约）

### 状态变更
| 变更 | 操作 |
|-----|------|
| pending → signed | 记录签约时间 |
| signed → in_progress | 记录开工时间 |
| in_progress → completed | 记录完工时间，客户状态更新 |
| pending → voided | 只有待签约状态可作废 |

### 金额计算
- `paidAmount` = 所有已确认收款的金额之和
- `costAmount` = 所有订单材料的成本之和
- 毛利 = `totalAmount - costAmount`

### 权限控制
| 操作 | 权限标识 | 角色 |
|-----|---------|-----|
| 查看列表 | order:list | 所有角色 |
| 创建订单 | order:create | 销售、管理员 |
| 编辑订单 | order:update | 销售、管理员 |
| 删除订单 | order:delete | 管理员 |
| 状态变更 | order:status | 销售、工长、管理员 |

## 前端页面

| 路由 | 组件 | 功能 |
|-----|------|-----|
| /order/list | features/order/List.tsx | 订单列表、筛选、搜索、CRUD |
| /order/detail/:id | features/order/Detail.tsx | 订单详情、材料、收款、状态变更 |
