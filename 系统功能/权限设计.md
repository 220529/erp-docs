# RBAC 权限设计

## 权限模型

```
┌─────────────────────────────────────────────────────────────────┐
│                      RBAC 权限模型                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────┐         ┌─────────┐         ┌─────────┐          │
│   │  User   │  n : 1  │  Role   │  n : n  │  Menu   │          │
│   │  用户   │────────▶│  角色   │────────▶│  菜单   │          │
│   └─────────┘         └─────────┘         └─────────┘          │
│                                                                 │
│   用户不直接拥有权限，而是通过角色间接获得权限                    │
│                                                                 │
│   示例：                                                        │
│   张三（销售）──→ 销售角色 ──→ [客户:查看, 客户:新增, 订单:查看]  │
│   李四（财务）──→ 财务角色 ──→ [收款:查看, 收款:确认, 报表:查看]  │
│   王五（管理员）──→ 管理员角色 ──→ [所有权限]                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 三层权限控制

```
┌─────────────────────────────────────────────────────────────────┐
│  第1层：菜单权限（前端）                                         │
│  控制用户能看到哪些菜单                                          │
│  销售看不到"系统管理"，财务看不到"客户管理"                       │
├─────────────────────────────────────────────────────────────────┤
│  第2层：按钮权限（前端）                                         │
│  控制页面内的操作按钮显示/隐藏                                   │
│  销售能"新增客户"，但不能"删除客户"、"导出客户"                  │
├─────────────────────────────────────────────────────────────────┤
│  第3层：接口权限（后端）                                         │
│  最后一道防线，防止绕过前端直接调接口                            │
│  即使前端隐藏了按钮，后端也要校验权限                            │
└─────────────────────────────────────────────────────────────────┘
```

## 权限标识设计

格式：`模块:操作`

```typescript
// 客户模块
'customer:list'    // 查看客户列表
'customer:create'  // 新增客户
'customer:update'  // 编辑客户
'customer:delete'  // 删除客户
'customer:export'  // 导出客户

// 订单模块
'order:list'
'order:create'
'order:update'
'order:delete'
'order:status'     // 状态变更

// 收款模块
'payment:list'
'payment:create'
'payment:confirm'  // 确认收款

// 系统模块
'system:user'      // 用户管理
'system:role'      // 角色管理
'system:menu'      // 菜单管理
```

## 预设角色

| 角色标识 | 角色名称 | 权限范围 |
|---------|---------|---------|
| admin | 系统管理员 | 所有权限 |
| sales | 销售 | 客户管理、订单管理（部分） |
| designer | 设计师 | 客户查看、产品方案管理 |
| foreman | 工长 | 订单查看、施工相关 |
| finance | 财务 | 收款管理、报表查看 |

## 后端实现

### 权限守卫
```typescript
@Injectable()
export class PermissionGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const requiredPermission = this.reflector.get('permission', handler);
    const user = request.user;
    
    // admin 直接放行
    if (user.role === 'admin') return true;
    
    // 检查用户是否有该权限
    const userPermissions = await this.permissionService.getUserPermissions(user.role);
    return userPermissions.includes(requiredPermission);
  }
}
```

### 权限装饰器
```typescript
@Delete(':id')
@RequirePermission('customer:delete')
async delete(@Param('id') id: number) {
  // ...
}
```

## 前端实现

### 权限 Hook
```typescript
export function usePermission() {
  const { permissions } = useAuthStore();

  const hasPermission = (permission: string) => {
    if (permissions.includes('*')) return true;
    return permissions.includes(permission);
  };

  return { hasPermission };
}
```

### 权限按钮组件
```tsx
<AuthButton permission="customer:delete" danger onClick={handleDelete}>
  删除
</AuthButton>
```

## 完整流程

```
1. 用户登录
   ↓
2. 后端验证 → 查询角色权限 → 返回 token + permissions + menus
   ↓
3. 前端存储 → 根据 menus 生成侧边栏
   ↓
4. 用户进入页面 → 根据 permissions 显示/隐藏按钮
   ↓
5. 用户点击按钮 → 发起 API 请求
   ↓
6. 后端 Guard 校验权限
   ├── 有权限 → 执行操作
   └── 无权限 → 返回 403
```
