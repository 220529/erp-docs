# 生产部署

## 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           生产环境架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        GitHub Actions                                │  │
│   │                        CI/CD 流水线                                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        阿里云 ACR                                    │  │
│   │                        镜像仓库                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        阿里云 ECS                                    │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │  │
│   │  │   Nginx     │  │  erp-core   │  │  erp-web    │                 │  │
│   │  │   :80/443   │  │   :3000     │  │  静态文件   │                 │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘                 │  │
│   │                                                                     │  │
│   │  ┌─────────────┐  ┌─────────────┐                                  │  │
│   │  │   MySQL     │  │   Redis     │                                  │  │
│   │  │   :3306     │  │   :6379     │                                  │  │
│   │  └─────────────┘  └─────────────┘                                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## CI/CD 流程

```
1. 开发者推送 Git Tag
   git tag v1.0.0
   git push origin v1.0.0
        │
        ▼
2. GitHub Actions 触发
   - 检出代码
   - 安装依赖
   - 运行测试
   - 构建镜像
        │
        ▼
3. 推送镜像到阿里云 ACR
   registry.cn-hangzhou.aliyuncs.com/xxx/erp-core:v1.0.0
        │
        ▼
4. SSH 连接服务器
   - 拉取最新镜像
   - 停止旧容器
   - 启动新容器
        │
        ▼
5. 部署完成
```

## GitHub Actions 配置

```yaml
name: Deploy

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: registry.cn-hangzhou.aliyuncs.com/xxx/erp-core:${{ github.ref_name }}
      
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/erp
            docker-compose pull
            docker-compose up -d
```

## 部署命令

### 手动部署
```bash
ssh user@server
cd /opt/erp
docker-compose pull
docker-compose up -d
docker-compose logs -f erp-core
```

### 回滚
```bash
docker-compose pull erp-core:v1.0.0
docker-compose up -d
```

## 监控告警

### 健康检查
```bash
curl http://localhost:3000/api/health
# 响应: { "status": "ok", "timestamp": "..." }
```

### 日志查看
```bash
docker logs -f erp-core --tail 100
tail -f /var/log/nginx/access.log
```

## 备份策略

### 数据库备份
```bash
# 手动备份
docker exec mysql mysqldump -uroot -p erp_core > backup_$(date +%Y%m%d).sql

# 定时备份（crontab）
0 2 * * * /opt/erp/scripts/backup.sh
```

## 安全配置

### 防火墙
```bash
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp
ufw enable
```

### SSL 证书
```bash
certbot certonly --webroot -w /var/www/html -d erp.example.com
# 自动续期
0 0 1 * * certbot renew --quiet
```
